{% extends "base.html" %}

{% block title %}Blockchain Explorer - FL-NFT{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="fas fa-cubes me-2"></i> Blockchain Explorer
            </h2>
            <p class="text-white-50">Real-time visualization of the NFT Consent Ledger</p>
        </div>
    </div>

    <!-- Stats -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stats-card h-100">
                <div class="stats-icon">
                    <i class="fas fa-link"></i>
                </div>
                <div class="stats-number" id="chain-length">-</div>
                <div class="stats-label">Total Blocks</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card h-100">
                <div class="stats-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-number text-success">Valid</div>
                <div class="stats-label">Integrity Status</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card h-100">
                <div class="stats-icon">
                    <i class="fas fa-fingerprint"></i>
                </div>
                <div class="stats-number" id="latest-hash" style="font-size: 1rem; word-break: break-all;">-</div>
                <div class="stats-label">Latest Hash</div>
            </div>
        </div>
    </div>

    <!-- Chain Visualization -->
    <div class="row">
        <div class="col-12">
            <div id="chain-container" class="d-flex flex-nowrap overflow-auto pb-4" style="gap: 2rem;">
                <!-- Blocks will be inserted here -->
                <div class="text-center w-100 text-white p-5">Loading Blockchain...</div>
            </div>
        </div>
    </div>
</div>

<style>
    .block-card {
        min-width: 300px;
        max-width: 300px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        position: relative;
        transition: all 0.3s ease;
    }

    .block-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .block-header {
        background: var(--primary-color);
        color: white;
        padding: 1rem;
        border-radius: 15px 15px 0 0;
        font-weight: bold;
    }

    .block-body {
        padding: 1rem;
        font-size: 0.9rem;
    }

    .hash-text {
        font-family: monospace;
        font-size: 0.75rem;
        color: #666;
        word-break: break-all;
    }

    .chain-link {
        position: absolute;
        right: -35px;
        top: 50%;
        color: rgba(255, 255, 255, 0.5);
        font-size: 1.5rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', loadBlockchain);

    async function loadBlockchain() {
        try {
            const response = await axios.get('/api/blockchain');
            const data = response.data;

            document.getElementById('chain-length').textContent = data.length;
            if (data.chain.length > 0) {
                document.getElementById('latest-hash').textContent = data.chain[data.chain.length - 1].hash.substring(0, 16) + '...';
            }

            const container = document.getElementById('chain-container');
            container.innerHTML = '';

            data.chain.forEach((block, index) => {
                const isGenesis = index === 0;
                const txCount = block.transactions.length;

                const blockHtml = `
                    <div class="position-relative">
                        <div class="block-card card border-0 shadow">
                            <div class="block-header d-flex justify-content-between align-items-center">
                                <span>Block #${block.index}</span>
                                <span class="badge bg-light text-dark">${txCount} Tx</span>
                            </div>
                            <div class="block-body">
                                <div class="mb-2">
                                    <strong>Timestamp:</strong><br>
                                    <small class="text-muted">${new Date(block.timestamp * 1000).toLocaleString()}</small>
                                </div>
                                <div class="mb-2">
                                    <strong>Previous Hash:</strong><br>
                                    <div class="hash-text">${isGenesis ? '0'.repeat(64) : block.previous_hash}</div>
                                </div>
                                <div class="mb-2">
                                    <strong>Hash:</strong><br>
                                    <div class="hash-text text-primary">${block.hash}</div>
                                </div>
                                <div class="mb-3">
                                    <strong>Nonce:</strong> ${block.nonce}
                                </div>
                                <div class="border-top pt-2">
                                    <strong>Transactions:</strong>
                                    <div class="mt-1" style="max-height: 100px; overflow-y: auto;">
                                        ${block.transactions.map(tx => `
                                            <div class="small mb-1 p-1 bg-light rounded">
                                                <span class="badge bg-secondary text-uppercase" style="font-size: 0.6rem;">${tx.type}</span>
                                                <span class="hash-text">${tx.patient_id}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${index < data.chain.length - 1 ? '<i class="fas fa-link chain-link"></i>' : ''}
                    </div>
                `;
                container.innerHTML += blockHtml;
            });

        } catch (error) {
            console.error(error);
            alert('Failed to load blockchain data');
        }
    }
</script>
{% endblock %}